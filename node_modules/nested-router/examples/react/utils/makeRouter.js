var { match } = require('../../../index');

var validateTransition = (routes, ref) => {
  return !routes.length || routes.filter((route) => {
    return route.validate;
  }).reduceRight((valid, route) => {
    return route.validate(ref);
  }, true);
};

var makeRouter = module.exports = (routes, location, callback) => {

  var transient = {
    ref: {},
    handlers: [],
    aborted: false,
    path: ''
  };

  var mutateTransient = (changes) => {
    for (var key in changes)
      transient[key] = changes[key];
  };

  var restoreUrl = () => {
    mutateTransient({ aborted: true });
    location.push(transient.path);
  };

  location.listen(() => {
    if (transient.aborted)
      return mutateTransient({ aborted: false });

    if (!validateTransition(transient.handlers, transient.ref))
      return restoreUrl();

    var path = location.getPath();
    var matchInfo = match(path, routes);
    var { handlers, params } = matchInfo;

    mutateTransient({ handlers, path });
    callback(matchInfo, (ref) => mutateTransient({ ref }));
  });
};

