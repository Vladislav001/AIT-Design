<link rel="stylesheet" href="/css/styleResultTest.css">
<% layout('layout/page') -%>
<% block('title') -%>

<!-- LEFT START -->
  <div class="main-and-sidebar-wrapper-left">
      <section class="main-left">
      <img src="<%=url_photoStudent%>" class="photoStudent">
      </section>
  </div>
<!-- LEFT END -->

<!-- CENTER START -->
  <div class="main-and-sidebar-wrapper">
      <section class="main">

          <form class="form-updateStudent" name="cabinet_updateStudent">
          <table>
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Gender</th>
                <th scope="col">Age</th>
                <th scope="col">Current test</th>
                <th scope="col">Current result</th>
                <th scope="col">Photo</th>
                <th scope="col">Test settings</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td aria-label="Name"><input name="updateNameStudent" type="text" value="<%=nameStudent%>" class="update-personal-data" id="input-updateNameStudent" placeholder="Name" required></td>
                <td aria-label="Gender">
                  <SELECT name="updateGenderStudent" type="text" class="update-personal-data" id="input-genderNewUser" required>
                    <% switch (genderStudent) {
                         case "Male": %>
                           <OPTION><%=genderStudent%></OPTION>
                           <OPTION>Female</OPTION>
                           <OPTION>Non-binary</OPTION>
                           <OPTION>Not-applicable</OPTION>
                           <OPTION>I prefer not say</OPTION>
                            <% break;%> <%
                           case "Female": %>
                             <OPTION><%=genderStudent%></OPTION>
                             <OPTION>Male</OPTION>
                             <OPTION>Non-binary</OPTION>
                             <OPTION>Not-applicable</OPTION>
                             <OPTION>I prefer not say</OPTION>
                              <% break;%> <%
                              case "Non-binary": %>
                                <OPTION><%=genderStudent%></OPTION>
                                <OPTION>Male</OPTION>
                                <OPTION>Female</OPTION>
                                <OPTION>Not-applicable</OPTION>
                                <OPTION>I prefer not say</OPTION>
                                 <% break;%> <%
                                 case "Not-applicable": %>
                                   <OPTION><%=genderStudent%></OPTION>
                                   <OPTION>Male</OPTION>
                                   <OPTION>Female</OPTION>
                                   <OPTION>Non-binary</OPTION>
                                   <OPTION>I prefer not say</OPTION>
                                    <% break;%> <%
                                    case "I prefer not say": %>
                                      <OPTION><%=genderStudent%></OPTION>
                                      <OPTION>Male</OPTION>
                                      <OPTION>Female</OPTION>
                                      <OPTION>Non-binary</OPTION>
                                      <OPTION>Not-applicable</OPTION>
                                       <% break;%> <%
                                        } %>
                    </SELECT></td>
                <td aria-label="Age"><input name="updateAgeStudent" type="text" value="<%=ageStudent%>" class="update-personal-data" id="input-updateAgeStudent" placeholder="Age" required pattern="^[ 0-9]+$"></td>
                <td aria-label="Current test">
                  <SELECT name="updateCurrentTest" type="text" class="update-personal-data" id="input-currentTest" required>
                    <% switch (currentTest) {
                    case "1": %>
                      <OPTION><%=currentTest%></OPTION>
                      <OPTION>2</OPTION>
                       <% break; %><%
                      case "2": %>
                        <OPTION><%=currentTest%></OPTION>
                        <OPTION>1</OPTION>
                         <% break; %> <% } %>
                  <OPTION><%=currentTest%></OPTION>
                  <OPTION>1</OPTION>
        </SELECT></td>
                <td aria-label="Current result">
                  <SELECT name="updateCurrentResult" type="text" class="update-personal-data" id="input-currentResult" required>
                    <OPTION><%=currentResult%></OPTION>
                      <% for(var i=1; i<=numbersResults; i++) { %>
                    <OPTION><%=[i]%></OPTION>
                     <% } %>
        </SELECT></td>
        <td><input type="file" class="upload" id="upload_photo" size="50" name="icon" onchange="loadPhoto(this);">
          <div id="myProgress">
            <div id="myBar"></div>
          </div></td>
                <td aria-label="Test settings"><a href="<%=link%>">Start</a></td>
              </tr>
            </tbody>
          </table>
    <button type="submit" class="update-student" data-loading-text="Updating..."id="updateStudent">Update student</button>
    </form>

    <form class="form-deleteStudent" name="cabinet_deleteStudent">
    <button type="submit" class="delete-student" onclick="return confirmDelete();" data-loading-text="Deleting..."id="deleteStudent">Delete student</button>
    </form>

<h2>Current Login</h2>
<div class = "settings_entrance_input" id="">
<img src="<%=url_1_login%>" class="img-responsive" id="imageEntranceLoginInput_1">
<img src="<%=url_2_login%>" class="img-responsive" id="imageEntranceLoginInput_2">
<img src="<%=url_3_login%>" class="img-responsive" id="imageEntranceLoginInput_3">
<img src="<%=url_4_login%>" class="img-responsive" id="imageEntranceLoginInput_4">
<input name="imageEntranceLoginInput_1" class="imageEntranceLoginInput_1" type="hidden" value="">
<input name="imageEntranceLoginInput_2" class="imageEntranceLoginInput_2" type="hidden" value="">
<input name="imageEntranceLoginInput_3" class="imageEntranceLoginInput_3" type="hidden" value="">
<input name="imageEntranceLoginInput_3" class="imageEntranceLoginInput_4" type="hidden" value="">
<!-- <img src="/imagesDefault/delete_all.png" class="img-responsive delete_all" id="delete_all_images_login"> -->
</div>
<!-- <div class = "settings_entrance_input" id="styleSettingsEntrance">
<img src="" class="img-responsive" id="imageEntranceLogin_1">
<img src="" class="img-responsive" id="imageEntranceLogin_2">
<img src="" class="img-responsive" id="imageEntranceLogin_3">
<img src="" class="img-responsive" id="imageEntranceLogin_4">
<img src="" class="img-responsive" id="imageEntranceLogin_5">
<img src="" class="img-responsive" id="imageEntranceLogin_6">
<img src="" class="img-responsive" id="imageEntranceLogin_7">
</div> -->

<h2>Current Password</h2>
<div class = "settings_entrance_input" id="">
<img src="<%=url_1_password%>" class="img-responsive" id="imageEntrancePasswordInput_1">
<img src="<%=url_2_password%>" class="img-responsive" id="imageEntrancePasswordInput_2">
<img src="<%=url_3_password%>" class="img-responsive" id="imageEntrancePasswordInput_3">
<img src="<%=url_4_password%>" class="img-responsive" id="imageEntrancePasswordInput_4">
<input name="imageEntrancePasswordInput_1" class="imageEntrancePasswordInput_1" type="hidden" value="">
<input name="imageEntrancePasswordInput_2" class="imageEntrancePasswordInput_2" type="hidden" value="">
<input name="imageEntrancePasswordInput_3" class="imageEntrancePasswordInput_3" type="hidden" value="">
<input name="imageEntrancePasswordInput_4" class="imageEntrancePasswordInput_4" type="hidden" value="">
<!-- <img src="/imagesDefault/delete_all.png" class="img-responsive delete_all" id="delete_all_images_password"> -->
</div>

<!-- <div class = "settings_entrance_input" id="">
<img src="" class="img-responsive" id="imageEntrancePassword_1">
<img src="" class="img-responsive" id="imageEntrancePassword_2">
<img src="" class="img-responsive" id="imageEntrancePassword_3">
<img src="" class="img-responsive" id="imageEntrancePassword_4">
<img src="" class="img-responsive" id="imageEntrancePassword_5">
<img src="" class="img-responsive" id="imageEntrancePassword_6">
<img src="" class="img-responsive" id="imageEntrancePassword_7">
</div> -->

<h3 id="currentQuestion">Current question: <%=currentQuestion%></h3>
<h3 id="currentState">Current state: <%=currentState%></h3>

<table id="tl_results">
  <caption><b>Test results</b></caption>
    <tr>
      <th scope="col">№</th>
      <th scope="col">Category</th>
      <th scope="col">Title</th>
      <th scope="col">Answer</th>
      <th scope="col">Level of happiness</th>
    </tr>
</table>

<table id="tl_category_results">
  <caption><b>Category results</b></caption>
    <tr>
      <th scope="col">№</th>
      <th scope="col">Category</th>
      <th scope="col">Accept</th>
    </tr>
</table>

      </section>
  </div>
<!-- CENTER END -->

<!-- RIGHT START -->
  <div class="main-and-sidebar-wrapper-right">
      <section class="main-right">

      </section>
  </div>
<!-- RIGHT END -->

  </div>

  <!-- <footer>
      <h3>Footer</h3>
      <p>Something.</p>
  </footer> -->




<script>
var config = {
  apiKey: "AIzaSyDivSiqkv7QoDAe8qiY1QevU5N4vQ7aHZw",
  authDomain: "profpref-c5ce0.firebaseapp.com",
  databaseURL: "https://profpref-c5ce0.firebaseio.com",
  projectId: "profpref-c5ce0",
  storageBucket: "profpref-c5ce0.appspot.com",
  messagingSenderId: "664101035809"
};
firebase.initializeApp(config);

// Отслеживаем текущий вопрос студента
var refStudents = firebase.database().ref("students/" + "<%=id%>");
var refCurrentQuestion = refStudents.child("/student_state/");

// Получаем доступ к Хранилищу
var storage = firebase.app().storage("profpref-c5ce0.appspot.com");

// устанавливаем слушатель child_changed
refStudents.on('child_changed', function(data) {
// существующий текущий вопр был изменен, получаем снэпшот, берем оттуда данные и обновляем пользовательский интерфейс
refCurrentQuestion.once("value")
 .then(function(snapshotState) {
   var currentQuestion = snapshotState.child('current_question').val();
   var currentState = snapshotState.child('state').val();

       var currentQuestionHTML = currentQuestion;
       var currentStateHTML = currentState;
       document.getElementById('currentQuestion').innerHTML = currentQuestionHTML;
       document.getElementById('currentState').innerHTML = currentStateHTML;
       console.log(currentQuestion + " studentState");
 });
});


var refAnswer = firebase.database().ref("students/" + "<%=id%>" + "/tests/" + "<%=currentTest%>" + "/results/" + "<%=currentResult%>");

// устанавливаем слушатель child_changed
refAnswer.on('child_added', function(snapshot) {
  var answer;
  var levelHappiness;

  if(snapshot.child('answer').val() == "-1") {
     answer = "<font color=" + "#D50000" + ">Dislike</font>"
   }
   if(snapshot.child('answer').val() == "0") {
     answer = "<font color=" + "#F9A825" + ">Swap</font>"
   }
    if(snapshot.child('answer').val() == "1") {
     answer = "<font color=" + "#4CAF50"+ ">Like</font>"
   }

  if (snapshot.child('category').val() != null) {
    $('#tl_results tbody').append('<tr cla ss="child"><td>' + (Number(snapshot.key) + 1) + '</td>' +
                                                    '<td>' + snapshot.child('category').val() + '</td>' +
                                                    '<td>' + snapshot.child('title').val() + '</td>' +
                                                    '<td>' + answer + '</td>' +
                                                    '<td>' + snapshot.child('pushHappines').val() + '</td>' +
                                                           + '</tr>');
                                                      }
});


// Обсчет результатов - сколько набрала какая категория и т.п
var refCategory = firebase.database().ref("students/" + "<%=id%>" + "/tests/" + "<%=currentTest%>" + "/results/" + "<%=currentResult%>" + "/category/");

refCategory.on('child_added', function(snapshotCountCategory) {

  var category;
  if(snapshotCountCategory.child('stateAccept').val() == "-1") {
    category = "<td><font color=" + "#4CAF50" + ">Accept</font></td>"
   }
    if(snapshotCountCategory.child('stateAccept').val() == "1") {
     category = "<td><font color=" + "#D50000"+ ">Not accept</font></td"
   }

   //console.log(category);
   $('#tl_category_results tbody').append('<tr class="child"><td>' + (Number(snapshotCountCategory.key) + 1) + '</td>' +
                                                             '<td>' + snapshotCountCategory.child('titleCategory').val() + '</td>' +
                                                               category +
                                                             + '</tr>');
 });



</script>

<script src="/js/countImagesRange.js"></script>

<script>
// Клиентский код //
// Человек вводит логин, email,
$(document.forms['cabinet_updateStudent']).on('submit', function() {
var form = $(this);
$('.error', form).html('');
$(":submit", form).button("loading");
// Этот логин, email, пароль отправляются на сервер
$.ajax({
  url: "/result_test/id<%=id%>", // роут: require('./registration').post
  method: "POST",
  data: form.serialize(),
  complete: function() {
    $(":submit", form).button("reset");
  },
  statusCode: {
    // если ответ сервера 200 - перенаправляем человека в личный кабинет(успешно создали нового пользователя)
    200: function() {
    location.reload();
    },
    // если 403 - высвечивается ошибка(уже есть такой пользователь)
    403: function(jqXHR) {
      var error = JSON.parse(jqXHR.responseText);
      $('.error', form).html(error.message);
    }
  }
});  //window.location.href = "/";
return false;

});
</script>

<script>
// Подтверждение удаления //
function confirmDelete() {
	if (confirm("Do you confirm the deletion?")) {
		return true;
	} else {
		return false;
	}
}
</script>

<script>
// Клиентский код //
// Человек вводит логин, email,
$(document.forms['cabinet_deleteStudent']).on('submit', function() {
var form = $(this);
$('.error', form).html('');
$(":submit", form).button("loading");
// Этот логин, email, пароль отправляются на сервер
$.ajax({
  url: "/deleteStudent/id<%=id%>", // роут: require('./registration').post
  method: "POST",
  data: form.serialize(),
  complete: function() {
    $(":submit", form).button("reset");
  }
  // ,
  // statusCode: {
  //   // если ответ сервера 200 - перенаправляем человека в личный кабинет(успешно создали нового пользователя)
  //   200: function() {
  //     form.html("Вы успешно зарегестрировались").addClass('alert-success');
  //     window.location.href = "/personalArea";
  //   }
  //,
  //   // если 403 - высвечивается ошибка(уже есть такой пользователь)
  //   403: function(jqXHR) {
  //     var error = JSON.parse(jqXHR.responseText);
  //     $('.error', form).html(error.message);
  //   }
  // }
});  //window.location.href = "/";
//return false;
window.location.href = "/personalArea";
return false;
location.reload();
});
</script>


<script>
// Загрузка файлов
function loadPhoto(input) {

        var elem = document.getElementById("myBar");
        var filetoUpload=input.files[0];

        var storageRef = firebase.storage().ref("photo_students/" + "<%=id%>" + "_photo" + ".png");
        var namePhotoDB = "<%=id%>" + "_photo" + ".png";
        console.log(input.value);

        var successForman = input.value.search(/^.*\.(?:jpg|jpeg|mp3|mp4)\s*$/ig)
          if(successForman!=0){
             alert("Invalid file format");
             return;
          }

        var task = storageRef.put(filetoUpload);

         task.on('state_changed',
            function progress(snapshot){
                var percentage = snapshot.bytesTransferred / snapshot.totalBytes * 100;
                //uploader.value = percentage;
                 elem.style.width = parseInt(percentage) + '%';
                 elem.innerHTML=parseInt(percentage)+'%';
            },
            function error(err){

            },
            function complete(){
                var downloadURL = task.snapshot.downloadURL;

                firebase.database().ref('students/<%=id%>/').update({
                    "photo": namePhotoDB
                  });

            }
        );
}
</script>
